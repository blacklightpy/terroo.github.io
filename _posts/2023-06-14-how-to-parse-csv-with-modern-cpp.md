---
layout: post
title: "How to Parse CSV with Modern C++"
date: 2023-06-14 08:46:49
image: '/assets/img/cpp/cppsv.jpg'
description: 'This post also shows how Modern C++ development works with Modern resources and tools.'
tags:
- cpp
- cppdaily
---

![{{ page.title }}]({{ page.image }} '{{ page.description }}')

---

In this post we are going to see how to parse [CSV](https://support.google.com/google-ads/answer/9004364) with [C++](https://terminalroot.com/tags#cpp) without any ready-made library for this and use some modern tools and resources, such as:
+ [C++23](https://en.cppreference.com/w/cpp/23)
+ [Using `fmtlib`](https://github.com/fmtlib/fmt)
+ [Safe memory](https://en.cppreference.com/w/cpp/header/memory)
+ [Static analysis](https://en.cppreference.com/book/intro/smart_pointers)
+ [CMake](https://terminalroot.com/tags#cmake)

---

# What is CSV?
**CSV** means "*Comma-separated values*". In short, they are text files used to store data as a "database".

The RFC standard describes data as comma-separated, however, there are variants that inform in the first line the indication that which separator(`sep=;`, `sep=|`) will be used in the document, in fact, Microsoft Excel exports data to CSV with this variant.

---

To create our code we will need an example of CSV and for that we will use this example:

# `file.csv`

{% highlight csv %}
Bjarne Stroustroup,1979,C++,bjarne@stroustroup.com
Dennis Ritchie,1970,C,dennis@ritchie.net
Maurice Wilkes,1940,Assembly,maurice@wilkes.us
Brian Kernighan,1977,AWK,brian@kernighan.org
Anonymous,,,anom@null.net
{% endhighlight %}

The code below uses `strsep` instead of [strtok](https://terminalroot.com/how-to-easily-create-tokens-with-cpp-and-c/) as we saw [in this article](https://terminalroot.com/how-to-easily-create-tokens-with-cpp-and-c/), to notice the difference I suggest replacing those with `strsep(&buf, delim)` by `strtok(NULL, delim)` and note that the line that has empty data will have incorrect data.

---

# Code [C++](https://terminalroot.com/tags#cpp)

{% highlight bash %}
mkdir cppsv
cd cppsv
vim main.cpp
{% endhighlight %}

> `main.cpp`

{% highlight cpp %}
#include <fmt/format.h>
#include <fstream>
#include <cstring>
#include <array>

auto main(int argc, char **argv) -> int {
   if(argc > 1){
     std::string line {};
     std::ifstream file(argv[1]);
     if(file.is_open()){
       const char * delim = ",";
       std::array<std::string, 4> fields {"NAME", "YEAR", "LANG", "MAIL"};
       int i {};
       while(std::getline(file, line)){
         char * buf = &line[0];
         char * pline = strsep(&buf, delim);
         while(pline != NULL){
           fmt::print("{}: {}\n", fields[i], pline);
           pline = strsep(&buf, delim);
           ++i;
           if(i > 3){
             fmt::print("-------\n");
             i = 0;
           }
         }
       }
       file.close();
     }
   }else{
     fmt::print(stderr, "Use: {} file.csv\n", argv[0]);
   }
}
{% endhighlight %}

---

# `CMakeLists.txt` file

{% highlight cpp %}
cmake_minimum_required(VERSION 3.26.3)
project(cppsv
   LANGUAGES CXX
   VERSION 0.0.1
)
add_compile_options(-Wall -Werror -Wextra -Wpedantic)
set (CMAKE_CXX_STANDARD 23)
add_executable(a.out main.cpp)
find_package(fmt)
target_link_libraries(a.out PRIVATE fmt::fmt-header-only)
{% endhighlight %}

---

# Contents of the directory and compiling the code

> `tree cppsv`

{% highlight bash %}
cppsv
├── CMakeLists.txt
├── file.csv
└── main.cpp

0 directories, 3 files
{% endhighlight %}

Compiling and running:

{% highlight bash %}
cmake -B build .
cd build && make
./a.out ../file.csv
{% endhighlight %}

---

Very easy and a nice C++ exercise. Of course, you can still improve, for example, add separator checking to be compatible with the model generated by Excel. And even create a ready-made library. Another thing is that some CSV files may have the data protected by double quotes, so you can replace them with empty and so on.

---

# Video
If you want to see the whole process step by step in video form, watch the content below, remembering that the video is in Portuguese, but the content is language independent, however, you can still use Youtube's automatic translation.

<iframe width="1253" height="705" src="https://www.youtube.com/embed/xYQt8fyXSp0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

---

<!--
+ <https://www.gnu.org/software/libc/manual/html_node/POSIX-Safety-Concepts.html#:~:text=MT%2DSafe%20or%20Thread%2DSafe,mechanisms%20POSIX%20exposes%20to %20users.>
+ <https://en.wikipedia.org/wiki/Thread_safety>
+ <https://refactoring.com/catalog/reduceScopeOfVariable.html>
+ <https://www.youtube.com/watch?v=5laM0Qwzpq8>
+ <https://en.wikipedia.org/wiki/Comma-separated_values>
+ <https://github.com/d99kris/rapidcsv>
+ <https://cpp.libhunt.com/csv-alternatives>
+ <https://pt.wikipedia.org/wiki/Comma-separated_values>
+ <https://pt.stackoverflow.com/questions/97269/how-to-read-a-csv-file-in-python>
+ <https://docs.python.org/pt-br/3/library/csv.html>
+ <https://www.reddit.com/r/cpp_questions/comments/uf1nk3/how_to_install_fmt_with_cmake/>
+ <https://fmt.dev/latest/usage.html>
-->

